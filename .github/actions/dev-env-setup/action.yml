name: "Set up registration dev environment"
description: "Sets up asdf and configures the cache"
runs:
  using: composite
  steps:
    - uses: actions/checkout@v6

    - name: Install asdf (root)
      uses: asdf-vm/actions/install@v4
      with:
        node: true
        cache: true

    - name: Install asdf backend tools (bc_obps)
      uses: asdf-vm/actions/install@v4
      with:
        working_directory: bc_obps
        cache: true

    - uses: ./.github/actions/yarn-cache

    - name: Install Yarn dependencies (bciers)
      working-directory: ./bciers
      shell: bash
      run: |
        corepack enable
        yarn install --immutable --frozen-lockfile

    - name: Get Python version from bc_obps/.tool-versions
      id: python-version
      shell: bash
      run: |
        VERSION=$(grep "^python" bc_obps/.tool-versions | awk '{print $2}')
        echo "version=$VERSION" >> $GITHUB_OUTPUT

    - name: Cache Poetry virtual environment
      id: poetry-cache
      uses: actions/cache@v4
      with:
        path: ./bc_obps/.venv
        key: venv-${{ runner.os }}-python-${{ steps.python-version.outputs.version }}-${{ hashFiles('bc_obps/poetry.lock') }}
        restore-keys: |
          venv-${{ runner.os }}-python-${{ steps.python-version.outputs.version }}-

    - name: Configure Poetry + install deps (only if venv cache miss)
      if: steps.poetry-cache.outputs.cache-hit != 'true'
      working-directory: ./bc_obps
      shell: bash
      run: |
        poetry config virtualenvs.in-project true
        poetry install --no-interaction --no-root

    - name: Configure Poetry venv (always run – ensures correct Python)
      working-directory: ./bc_obps
      shell: bash
      run: |
        poetry config virtualenvs.in-project true
        poetry env use $(asdf which python) || true  # safe if already correct

    - name: Start PostgreSQL and create database
      working-directory: ./bc_obps
      shell: bash
      run: |
        make start_pg
        make create_db

    - name: Cache summary
      shell: bash
      run: |
        echo "asdf tools (Node, Python, Postgres) → automatically cached"
        echo "Yarn cache → handled by your custom action"
        echo "Poetry .venv → ${{ steps.poetry-cache.outputs.cache-hit == 'true' && 'HIT' || 'MISS' }}"
