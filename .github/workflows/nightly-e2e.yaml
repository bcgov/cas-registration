name: Nightly E2E Tests

on:
  schedule:
    # Run every night at 12 AM PST (8 AM UTC)
    - cron: "0 8 * * *"
  workflow_dispatch: # Allow manual triggering

concurrency:
  group: nightly-e2e-${{ github.ref }}
  cancel-in-progress: true

env:
  PGUSER: postgres

jobs:
  build-backend:
    uses: ./.github/workflows/build-backend.yaml

  build-administration:
    uses: ./.github/workflows/build-administration.yaml

  build-registration:
    uses: ./.github/workflows/build-registration.yaml

  build-dashboard-e2e:
    uses: ./.github/workflows/build-dashboard-e2e.yaml

  build-compliance:
    uses: ./.github/workflows/build-compliance.yaml

  build-reporting:
    uses: ./.github/workflows/build-reporting.yaml

  # Run all e2e tests regardless of NX affected status
  test-administration-e2e:
    needs: [build-backend, build-dashboard-e2e, build-administration]
    uses: ./.github/workflows/test-nx-project-e2e.yaml
    with:
      image_url: "ghcr.io/bcgov/cas-admin-frontend"
      is_nx_affected: true # Always run in nightly builds
      nx_app_port: 4001
      nx_project: administration
    secrets: inherit

  test-registration-e2e:
    needs: [build-backend, build-dashboard-e2e, build-registration]
    uses: ./.github/workflows/test-nx-project-e2e.yaml
    with:
      image_url: "ghcr.io/bcgov/cas-reg-frontend"
      is_nx_affected: true # Always run in nightly builds
      nx_app_port: 4000
      nx_project: registration
    secrets: inherit

  test-dashboard-e2e:
    needs:
      [
        build-administration,
        build-backend,
        build-compliance,
        build-dashboard-e2e,
        build-registration,
        build-reporting,
      ]
    uses: ./.github/workflows/test-nx-project-e2e.yaml
    with:
      docker_compose_file: "docker-compose-bciers-apps.yaml"
      image_url: "ghcr.io/bcgov/cas-dash-frontend"
      is_nx_affected: true # Always run in nightly builds
      nx_project: dashboard
    secrets: inherit

  nightly-summary:
    name: ðŸ“Š Nightly E2E Summary
    runs-on: ubuntu-latest
    needs: [test-administration-e2e, test-registration-e2e, test-dashboard-e2e]
    if: always()
    steps:
      - name: Check E2E Test Results
        run: |
          echo "## Nightly E2E Test Results" >> $GITHUB_STEP_SUMMARY
          echo "**Run Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.test-administration-e2e.result }}" == "success" ]]; then
            echo "âœ… **Administration E2E:** PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Administration E2E:** FAILED" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ "${{ needs.test-registration-e2e.result }}" == "success" ]]; then
            echo "âœ… **Registration E2E:** PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Registration E2E:** FAILED" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ "${{ needs.test-dashboard-e2e.result }}" == "success" ]]; then
            echo "âœ… **Dashboard E2E:** PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Dashboard E2E:** FAILED" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
