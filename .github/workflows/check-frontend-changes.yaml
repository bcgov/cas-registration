name: Check frontend changes

on:
  workflow_call:
    outputs:
      has_changes:
        description: "Whether any files in bciers directory have changed"
        value: ${{ jobs.check.outputs.has_changes }}

jobs:
  check:
    runs-on: ubuntu-latest
    outputs:
      has_changes: ${{ steps.check-frontend-changes.outputs.changed }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          sparse-checkout: |
            bciers/
            .tool-versions
      - name: Check for frontend changes
        id: check-frontend-changes
        run: |
          # For PRs, compare against base branch. For pushes to develop/main, always report changes
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BASE_REF="origin/${{ github.base_ref }}"

            # Debug: show what we're comparing
            echo "BASE_REF: $BASE_REF"
            echo "HEAD: $(git rev-parse HEAD)"
            echo "BASE_REF commit: $(git rev-parse $BASE_REF)"

            # Write to temp file to avoid pipe buffer issues with large diffs
            CHANGED_FILES_TMP=$(mktemp)
            set +e
            git diff --name-only $BASE_REF...HEAD > "$CHANGED_FILES_TMP" 2>&1
            DIFF_EXIT_CODE=$?
            set -e

            echo "git diff exit code: $DIFF_EXIT_CODE"
            echo "Number of changed files: $(wc -l < "$CHANGED_FILES_TMP" | tr -d ' ')"

            if [ $DIFF_EXIT_CODE -ne 0 ]; then
              echo "git diff failed with:"
              cat "$CHANGED_FILES_TMP"
              echo "changed=true" >> "$GITHUB_OUTPUT"
            elif grep -qE "^(bciers/|\.tool-versions)" "$CHANGED_FILES_TMP"; then
              echo "changed=true" >> "$GITHUB_OUTPUT"
            else
              echo "changed=false" >> "$GITHUB_OUTPUT"
              echo "No bciers/ or .tool-versions changes found. First 20 changed files:"
              head -20 "$CHANGED_FILES_TMP"
            fi
            rm -f "$CHANGED_FILES_TMP"
          else
            # For pushes to develop/main, always report changes
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi
        shell: bash
