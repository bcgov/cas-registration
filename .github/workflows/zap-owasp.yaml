name: ZAP OWASP Scan BCIERS

on:
  workflow_call:

env:
  PGUSER: postgres
  DJANGO_SECRET_KEY: ${{ secrets.DJANGO_SECRET_KEY }}

jobs:
  zap-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up BCIERS apps for scanning
        run: docker-compose -f docker-compose-bciers.yaml up -d --build
      
      - name: Wait for services to start
        run: sleep 60 # Adjust based on startup time

      - name: ZAP Scan - Dashboard
        uses: zaproxy/action-baseline@v0.14.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          target: "http://localhost:3000/"
          issue_title: OWASP Scan - Dashboard
          fail_action: false

      - name: ZAP Scan - Administration
        uses: zaproxy/action-baseline@v0.14.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          target: "http://localhost:4001/"
          issue_title: OWASP Scan - Administration
          fail_action: false

      - name: ZAP Scan - Compliance
        uses: zaproxy/action-baseline@v0.14.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          target: "http://localhost:7000/"
          issue_title: OWASP Scan - Compliance
          fail_action: false

      - name: ZAP Scan - Registration
        uses: zaproxy/action-baseline@v0.14.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          target: "http://localhost:4000/"
          issue_title: OWASP Scan - Registration
          fail_action: false

      - name: ZAP Scan - Backend
        uses: zaproxy/action-baseline@v0.14.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          target: "http://0.0.0.0:8000/"
          issue_title: OWASP Scan - Backend
          fail_action: false

      - name: Cleanup
        run: docker-compose -f docker-compose-bciers.yaml down
