# Generated by Django 5.1.15 on 2026-02-05 20:20

from django.db import migrations


def create_pulp_and_paper_2025_configuration_elements(apps, schema_editor):
    ConfigurationElement = apps.get_model('reporting', 'ConfigurationElement')
    Activity = apps.get_model('registration', 'Activity')
    SourceType = apps.get_model('reporting', 'SourceType')
    GasType = apps.get_model('reporting', 'GasType')
    Methodology = apps.get_model('reporting', 'Methodology')
    Configuration = apps.get_model('reporting', 'Configuration')
    ReportingField = apps.get_model('reporting', 'ReportingField')

    # Get configurations
    config_2024 = Configuration.objects.get(slug='2024', valid_from='2023-01-01', valid_to='2024-12-31')
    config_2025 = Configuration.objects.get(slug='2025', valid_from='2025-01-01', valid_to='2099-12-31')

    # Get activity and source type
    activity = Activity.objects.get(name='Pulp and paper production')
    source_type = SourceType.objects.get(name='Pulping and chemical recovery')

    # Update existing Pulp & Paper ConfigurationElements to end at 2024 config
    ConfigurationElement.objects.filter(activity=activity).update(valid_to_id=config_2024.id)

    # Create configuration elements for CO2
    co2_gas = GasType.objects.get(chemical_formula='CO2')

    # CO2 methodologies
    co2_methodologies = [
        'Solids-HHV',
        'Solids-CC',
        'Make-up Chemical Use Methodology',
        'Alternative Parameter Measurement Methodology',
        'Replacement Methodology',
    ]

    for methodology_name in co2_methodologies:
        methodology = Methodology.objects.get(name=methodology_name)
        ConfigurationElement.objects.create(
            activity=activity,
            source_type=source_type,
            gas_type=co2_gas,
            methodology=methodology,
            valid_from=config_2025,
            valid_to=config_2025,
        )

    # Create configuration elements for CH4
    ch4_gas = GasType.objects.get(chemical_formula='CH4')

    ch4_methodologies = [
        'Solids-HHV',
        'Alternative Parameter Measurement Methodology',
        'Replacement Methodology',
    ]

    for methodology_name in ch4_methodologies:
        methodology = Methodology.objects.get(name=methodology_name)
        ConfigurationElement.objects.create(
            activity=activity,
            source_type=source_type,
            gas_type=ch4_gas,
            methodology=methodology,
            valid_from=config_2025,
            valid_to=config_2025,
        )

    # Create configuration elements for N2O
    n2o_gas = GasType.objects.get(chemical_formula='N2O')

    n2o_methodologies = [
        'Solids-HHV',
        'Alternative Parameter Measurement Methodology',
        'Replacement Methodology',
    ]

    for methodology_name in n2o_methodologies:
        methodology = Methodology.objects.get(name=methodology_name)
        ConfigurationElement.objects.create(
            activity=activity,
            source_type=source_type,
            gas_type=n2o_gas,
            methodology=methodology,
            valid_from=config_2025,
            valid_to=config_2025,
        )

    # Now add reporting fields to each configuration element
    # CO2 - Solids-HHV
    ce = ConfigurationElement.objects.get(
        activity=activity,
        source_type=source_type,
        gas_type=co2_gas,
        methodology=Methodology.objects.get(name='Solids-HHV'),
        valid_from=config_2025,
    )
    ce.reporting_fields.add(
        ReportingField.objects.get(field_name='Mass of spent liquor combusted (tonnes/year)', field_units__isnull=True),
        ReportingField.objects.get(field_name='Solids percentage by weight (%)', field_units__isnull=True),
        ReportingField.objects.get(
            field_name='Annual high heat value of spent liquor solids (GJ/kg)', field_units__isnull=True
        ),
    )

    # CO2 - Solids-CC
    ce = ConfigurationElement.objects.get(
        activity=activity,
        source_type=source_type,
        gas_type=co2_gas,
        methodology=Methodology.objects.get(name='Solids-CC'),
        valid_from=config_2025,
    )
    ce.reporting_fields.add(
        ReportingField.objects.get(field_name='Mass of spent liquor combusted (tonnes/year)', field_units__isnull=True),
        ReportingField.objects.get(field_name='Solids percentage by weight (%)', field_units__isnull=True),
        ReportingField.objects.get(
            field_name='Annual carbon content of spent liquor solids (% by weight)', field_units__isnull=True
        ),
    )

    # CO2 - Make-up Chemical Use Methodology
    ce = ConfigurationElement.objects.get(
        activity=activity,
        source_type=source_type,
        gas_type=co2_gas,
        methodology=Methodology.objects.get(name='Make-up Chemical Use Methodology'),
        valid_from=config_2025,
    )
    ce.reporting_fields.add(
        ReportingField.objects.get(field_name='Make-up quantity of CaCO3 used (tonnes/year)', field_units__isnull=True),
        ReportingField.objects.get(
            field_name='Make-up quantity of Na2CO3 used (tonnes/year)', field_units__isnull=True
        ),
    )

    # CO2 - Alternative Parameter Measurement Methodology
    ce = ConfigurationElement.objects.get(
        activity=activity,
        source_type=source_type,
        gas_type=co2_gas,
        methodology=Methodology.objects.get(name='Alternative Parameter Measurement Methodology'),
        valid_from=config_2025,
    )
    ce.reporting_fields.add(
        ReportingField.objects.get(field_name='Description', field_units__isnull=True),
        ReportingField.objects.get(field_name='Is Woody Biomass', field_units__isnull=True),
    )

    # CO2 - Replacement Methodology
    ce = ConfigurationElement.objects.get(
        activity=activity,
        source_type=source_type,
        gas_type=co2_gas,
        methodology=Methodology.objects.get(name='Replacement Methodology'),
        valid_from=config_2025,
    )
    ce.reporting_fields.add(
        ReportingField.objects.get(field_name='Description', field_units__isnull=True),
        ReportingField.objects.get(field_name='Is Woody Biomass', field_units__isnull=True),
    )

    # CH4 - Solids-HHV
    ce = ConfigurationElement.objects.get(
        activity=activity,
        source_type=source_type,
        gas_type=ch4_gas,
        methodology=Methodology.objects.get(name='Solids-HHV'),
        valid_from=config_2025,
    )
    ce.reporting_fields.add(
        ReportingField.objects.get(field_name='Mass of spent liquor combusted (tonnes/year)', field_units__isnull=True),
        ReportingField.objects.get(field_name='Solids percentage by weight (%)', field_units__isnull=True),
        ReportingField.objects.get(
            field_name='Annual high heat value of spent liquor solids (GJ/kg)', field_units__isnull=True
        ),
    )

    # CH4 - Alternative Parameter Measurement Methodology
    ce = ConfigurationElement.objects.get(
        activity=activity,
        source_type=source_type,
        gas_type=ch4_gas,
        methodology=Methodology.objects.get(name='Alternative Parameter Measurement Methodology'),
        valid_from=config_2025,
    )
    ce.reporting_fields.add(
        ReportingField.objects.get(field_name='Description', field_units__isnull=True),
        ReportingField.objects.get(field_name='Is Woody Biomass', field_units__isnull=True),
    )

    # CH4 - Replacement Methodology
    ce = ConfigurationElement.objects.get(
        activity=activity,
        source_type=source_type,
        gas_type=ch4_gas,
        methodology=Methodology.objects.get(name='Replacement Methodology'),
        valid_from=config_2025,
    )
    ce.reporting_fields.add(
        ReportingField.objects.get(field_name='Description', field_units__isnull=True),
        ReportingField.objects.get(field_name='Is Woody Biomass', field_units__isnull=True),
    )

    # N2O - Solids-HHV
    ce = ConfigurationElement.objects.get(
        activity=activity,
        source_type=source_type,
        gas_type=n2o_gas,
        methodology=Methodology.objects.get(name='Solids-HHV'),
        valid_from=config_2025,
    )
    ce.reporting_fields.add(
        ReportingField.objects.get(field_name='Mass of spent liquor combusted (tonnes/year)', field_units__isnull=True),
        ReportingField.objects.get(field_name='Solids percentage by weight (%)', field_units__isnull=True),
        ReportingField.objects.get(
            field_name='Annual high heat value of spent liquor solids (GJ/kg)', field_units__isnull=True
        ),
    )

    # N2O - Alternative Parameter Measurement Methodology
    ce = ConfigurationElement.objects.get(
        activity=activity,
        source_type=source_type,
        gas_type=n2o_gas,
        methodology=Methodology.objects.get(name='Alternative Parameter Measurement Methodology'),
        valid_from=config_2025,
    )
    ce.reporting_fields.add(
        ReportingField.objects.get(field_name='Description', field_units__isnull=True),
        ReportingField.objects.get(field_name='Is Woody Biomass', field_units__isnull=True),
    )

    # N2O - Replacement Methodology
    ce = ConfigurationElement.objects.get(
        activity=activity,
        source_type=source_type,
        gas_type=n2o_gas,
        methodology=Methodology.objects.get(name='Replacement Methodology'),
        valid_from=config_2025,
    )
    ce.reporting_fields.add(
        ReportingField.objects.get(field_name='Description', field_units__isnull=True),
        ReportingField.objects.get(field_name='Is Woody Biomass', field_units__isnull=True),
    )


def reverse_create_pulp_and_paper_2025_configuration_elements(apps, schema_editor):
    """
    Reverse the Pulp & Paper ConfigurationElements changes:
    1. Delete the 2025 Pulp & Paper configuration elements
    2. Restore existing Pulp & Paper ConfigurationElements to span to 2025 config
    """
    ConfigurationElement = apps.get_model('reporting', 'ConfigurationElement')
    Activity = apps.get_model('registration', 'Activity')
    Configuration = apps.get_model('reporting', 'Configuration')

    config_2025 = Configuration.objects.get(slug='2025', valid_from='2025-01-01', valid_to='2099-12-31')
    activity = Activity.objects.get(name='Pulp and paper production')

    # Delete the 2025 configuration elements
    ConfigurationElement.objects.filter(
        activity=activity,
        valid_from=config_2025,
    ).delete()

    # Restore existing Pulp & Paper ConfigurationElements to span to 2025 config
    ConfigurationElement.objects.filter(activity=activity).update(valid_to_id=config_2025.id)


class Migration(migrations.Migration):

    dependencies = [
        ('reporting', '0156_pulp_and_paper_biogenic_emissions_2025'),
    ]

    operations = [
        migrations.RunPython(
            create_pulp_and_paper_2025_configuration_elements, reverse_create_pulp_and_paper_2025_configuration_elements
        ),
    ]
