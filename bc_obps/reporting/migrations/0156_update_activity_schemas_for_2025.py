# Generated by Django 5.1.15 on 2026-02-05 20:10

from django.db import migrations


def update_activity_schemas(apps, schema_editor):
    """
    Update all existing ActivityJsonSchema and ActivitySourceTypeJsonSchema records
    to span both 2024 and 2025 configurations.
    This allows schemas to remain valid across both years unless explicitly changed (e.g., Pulp & Paper).
    """
    Configuration = apps.get_model('reporting', 'Configuration')
    ActivityJsonSchema = apps.get_model('reporting', 'ActivityJsonSchema')
    ActivitySourceTypeJsonSchema = apps.get_model('reporting', 'ActivitySourceTypeJsonSchema')

    # Get the configurations
    config_2024 = Configuration.objects.get(slug='2024', valid_from='2023-01-01', valid_to='2024-12-31')
    config_2025 = Configuration.objects.get(slug='2025', valid_from='2025-01-01', valid_to='2099-12-31')

    # Update all ActivityJsonSchema records that point to 2024 config to instead point to 2025 config
    ActivityJsonSchema.objects.filter(valid_to_id=config_2024.id).update(valid_to_id=config_2025.id)

    # Update all ActivitySourceTypeJsonSchema records that point to 2024 config to instead point to 2025 config
    ActivitySourceTypeJsonSchema.objects.filter(valid_to_id=config_2024.id).update(valid_to_id=config_2025.id)


def reverse_update_activity_schemas(apps, schema_editor):
    """
    Reverse the update by restoring schema records to point to the 2024 configuration.
    """
    Configuration = apps.get_model('reporting', 'Configuration')
    ActivityJsonSchema = apps.get_model('reporting', 'ActivityJsonSchema')
    ActivitySourceTypeJsonSchema = apps.get_model('reporting', 'ActivitySourceTypeJsonSchema')

    config_2024 = Configuration.objects.get(slug='2024', valid_from='2023-01-01', valid_to='2024-12-31')

    # Restore all ActivityJsonSchema records to point to the 2024 config
    ActivityJsonSchema.objects.filter(valid_to_id__isnull=False).update(valid_to_id=config_2024.id)

    # Restore all ActivitySourceTypeJsonSchema records to point to the 2024 config
    ActivitySourceTypeJsonSchema.objects.filter(valid_to_id__isnull=False).update(valid_to_id=config_2024.id)


class Migration(migrations.Migration):

    dependencies = [
        ('reporting', '0155_update_configuration_elements_for_2025'),
    ]

    operations = [
        migrations.RunPython(update_activity_schemas, reverse_update_activity_schemas),
    ]
