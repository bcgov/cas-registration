# Generated by Django 5.1.15 on 2026-02-05 20:15

from django.db import migrations
import json


def init_pulp_and_paper_2025_schemas(apps, schema_editor):
    """
    Handle Pulp & Paper schema changes for 2025:
    1. End the existing Pulp & Paper schemas at the 2024 configuration
    2. Create new ActivityJsonSchema and ActivitySourceTypeJsonSchema for 2025 with biogenic emissions split fields
    """
    import os

    ActivityJsonSchema = apps.get_model('reporting', 'ActivityJsonSchema')
    ActivitySourceTypeJsonSchema = apps.get_model('reporting', 'ActivitySourceTypeJsonSchema')
    Activity = apps.get_model('registration', 'Activity')
    SourceType = apps.get_model('reporting', 'SourceType')
    Configuration = apps.get_model('reporting', 'Configuration')

    # Get the configurations
    config_2024 = Configuration.objects.get(slug='2024', valid_from='2023-01-01', valid_to='2024-12-31')
    config_2025 = Configuration.objects.get(slug='2025', valid_from='2025-01-01', valid_to='2099-12-31')

    # Get activity and source type
    pulp_paper_activity = Activity.objects.get(name='Pulp and paper production')
    pulping_source_type = SourceType.objects.get(name='Pulping and chemical recovery')

    # Update existing Pulp & Paper schemas to end at 2024 config
    ActivityJsonSchema.objects.filter(activity=pulp_paper_activity).update(valid_to_id=config_2024.id)
    ActivitySourceTypeJsonSchema.objects.filter(activity=pulp_paper_activity).update(valid_to_id=config_2024.id)

    # Load the new JSON schemas for 2025
    cwd = os.getcwd()

    with open(f'{cwd}/reporting/json_schemas/2025/pulp_and_paper_production/activity.json') as f:
        activity_schema = json.load(f)

    with open(f'{cwd}/reporting/json_schemas/2025/pulp_and_paper_production/pulp_and_paper_production.json') as f:
        source_type_schema = json.load(f)

    # Create new ActivityJsonSchema for 2025
    ActivityJsonSchema.objects.create(
        activity=pulp_paper_activity,
        json_schema=activity_schema,
        valid_from=config_2025,
        valid_to=config_2025,
    )

    # Create new ActivitySourceTypeJsonSchema for 2025
    ActivitySourceTypeJsonSchema.objects.create(
        activity=pulp_paper_activity,
        source_type=pulping_source_type,
        has_unit=False,
        has_fuel=False,
        json_schema=source_type_schema,
        valid_from=config_2025,
        valid_to=config_2025,
    )


def reverse_init_pulp_and_paper_2025_schemas(apps, schema_editor):
    ActivityJsonSchema = apps.get_model('reporting', 'ActivityJsonSchema')
    ActivitySourceTypeJsonSchema = apps.get_model('reporting', 'ActivitySourceTypeJsonSchema')
    Activity = apps.get_model('registration', 'Activity')
    Configuration = apps.get_model('reporting', 'Configuration')

    config_2025 = Configuration.objects.get(slug='2025', valid_from='2025-01-01', valid_to='2099-12-31')

    pulp_paper_activity = Activity.objects.get(name='Pulp and paper production')

    # Delete the 2025 schemas
    ActivityJsonSchema.objects.filter(
        activity=pulp_paper_activity,
        valid_from=config_2025,
    ).delete()

    ActivitySourceTypeJsonSchema.objects.filter(
        activity=pulp_paper_activity,
        valid_from=config_2025,
    ).delete()

    ActivityJsonSchema.objects.filter(activity=pulp_paper_activity).update(valid_to_id=config_2025.id)
    ActivitySourceTypeJsonSchema.objects.filter(activity=pulp_paper_activity).update(valid_to_id=config_2025.id)


class Migration(migrations.Migration):

    dependencies = [
        ('reporting', '0156_update_activity_schemas_for_2025'),
    ]

    operations = [
        migrations.RunPython(init_pulp_and_paper_2025_schemas, reverse_init_pulp_and_paper_2025_schemas),
    ]
