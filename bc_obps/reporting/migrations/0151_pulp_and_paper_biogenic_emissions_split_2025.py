# Generated by Django 5.1.15 on 2026-02-03 00:00

from django.db import migrations
import json


def init_2025_configuration(apps, schema_editor):
    '''
    Create 2025 configuration and update 2024 configuration end date
    '''
    Configuration = apps.get_model('reporting', 'Configuration')

    # Update 2024 configuration to end at 2024-12-31
    config_2024 = Configuration.objects.get(slug='2024')
    config_2024.valid_to = '2024-12-31'
    config_2024.save()

    # Create 2025 configuration
    Configuration.objects.create(slug='2025', valid_from='2025-01-01', valid_to='2099-12-31')


def reverse_init_2025_configuration(apps, schema_editor):
    '''
    Reverse the 2025 configuration changes
    '''
    Configuration = apps.get_model('reporting', 'Configuration')

    # Delete 2025 configuration
    Configuration.objects.filter(slug='2025').delete()

    # Restore 2024 configuration end date
    config_2024 = Configuration.objects.get(slug='2024')
    config_2024.valid_to = '2099-12-31'
    config_2024.save()


def init_pulp_and_paper_2025_activity_schema(apps, schema_editor):
    '''
    Add 2025 activity schema for Pulp and Paper Production with biogenic emissions split
    '''
    import os

    cwd = os.getcwd()
    with open(f'{cwd}/reporting/json_schemas/2025/pulp_and_paper_production/activity.json') as pulp_and_paper_2025:
        schema = json.load(pulp_and_paper_2025)

    ActivitySchema = apps.get_model('reporting', 'ActivityJsonSchema')
    Activity = apps.get_model('registration', 'Activity')
    Configuration = apps.get_model('reporting', 'Configuration')

    # Create new activity schema for 2025
    ActivitySchema.objects.create(
        activity_id=Activity.objects.get(name='Pulp and paper production').id,
        json_schema=schema,
        valid_from_id=Configuration.objects.get(slug='2025').id,
        valid_to_id=Configuration.objects.get(slug='2025').id,
    )


def reverse_init_pulp_and_paper_2025_activity_schema(apps, schema_editor):
    '''
    Remove 2025 activity schema for Pulp and Paper Production
    '''
    ActivitySchema = apps.get_model('reporting', 'ActivityJsonSchema')
    Activity = apps.get_model('registration', 'Activity')
    Configuration = apps.get_model('reporting', 'Configuration')

    ActivitySchema.objects.filter(
        activity_id=Activity.objects.get(name='Pulp and paper production').id,
        valid_from_id=Configuration.objects.get(slug='2025').id,
    ).delete()


def init_pulp_and_paper_2025_source_type_schema(apps, schema_editor):
    '''
    Add 2025 source type schema for Pulp and Paper Production
    '''
    import os

    cwd = os.getcwd()
    with open(
        f'{cwd}/reporting/json_schemas/2025/pulp_and_paper_production/pulp_and_paper_production.json'
    ) as pulp_and_paper_st_2025:
        schema = json.load(pulp_and_paper_st_2025)

    ActivitySourceTypeSchema = apps.get_model('reporting', 'ActivitySourceTypeJsonSchema')
    Activity = apps.get_model('registration', 'Activity')
    SourceType = apps.get_model('reporting', 'SourceType')
    Configuration = apps.get_model('reporting', 'Configuration')

    # Create new source type schema for 2025
    ActivitySourceTypeSchema.objects.create(
        activity_id=Activity.objects.get(name='Pulp and paper production').id,
        source_type_id=SourceType.objects.get(name='Pulping and chemical recovery').id,
        has_unit=False,
        has_fuel=False,
        json_schema=schema,
        valid_from_id=Configuration.objects.get(slug='2025').id,
        valid_to_id=Configuration.objects.get(slug='2025').id,
    )


def reverse_init_pulp_and_paper_2025_source_type_schema(apps, schema_editor):
    '''
    Remove 2025 source type schema for Pulp and Paper Production
    '''
    ActivitySourceTypeSchema = apps.get_model('reporting', 'ActivitySourceTypeJsonSchema')
    Activity = apps.get_model('registration', 'Activity')
    Configuration = apps.get_model('reporting', 'Configuration')

    ActivitySourceTypeSchema.objects.filter(
        activity_id=Activity.objects.get(name='Pulp and paper production').id,
        valid_from_id=Configuration.objects.get(slug='2025').id,
    ).delete()


class Migration(migrations.Migration):

    dependencies = [
        ('reporting', '0150_update_activity_json_schema_titles'),
    ]

    operations = [
        migrations.RunPython(init_2025_configuration, reverse_init_2025_configuration),
        migrations.RunPython(
            init_pulp_and_paper_2025_activity_schema, reverse_init_pulp_and_paper_2025_activity_schema
        ),
        migrations.RunPython(
            init_pulp_and_paper_2025_source_type_schema, reverse_init_pulp_and_paper_2025_source_type_schema
        ),
    ]
