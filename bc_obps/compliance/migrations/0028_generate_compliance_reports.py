# Generated by Django 5.1.10 on 2025-09-09 20:18

from django.db import migrations
from compliance.service.compliance_report_version_service import ComplianceReportVersionService


def generate_compliance_reports_from_emission_reports(apps):
    ReportVersion = apps.get_model("reporting", "ReportVersion")
    ComplianceReport = apps.get_model("compliance", "ComplianceReport")
    CompliancePeriod = apps.get_model("compliance", "CompliancePeriod")

    report_versions_to_process = ReportVersion.objects.filter(
        report__reporting_year_id=2024, report__operation__is_regulated_operation=True, is_latest_submitted=True
    )
    for rv in report_versions_to_process:
        if not (
            ComplianceReport.objects.filter(
                report_id=rv.report_id,
            )
        ).exists():
            new_compliance_report = ComplianceReport.objects.create(
                report=rv.report,
                compliance_period=CompliancePeriod.objects.get(reporting_year=2024),
            )
            ComplianceReportVersionService.create_compliance_report_version(new_compliance_report, rv.id)


def revert_generate_compliance_reports_from_emission_reports(apps):
    """
    Remove generated compliance reports
    """
    ComplianceReport = apps.get_model("compliance", "ComplianceReport")

    ComplianceReport.objects.all().delete()


class Migration(migrations.Migration):

    dependencies = [
        ('compliance', '0027_alter_elicensingadjustment_adjustment_date_and_more'),
    ]

    operations = [
        migrations.RunPython(
            generate_compliance_reports_from_emission_reports, revert_generate_compliance_reports_from_emission_reports
        )
    ]
