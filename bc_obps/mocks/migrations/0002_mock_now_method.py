# Generated by Django 5.1.14 on 2025-11-21 17:51

from django.db import migrations


class Migration(migrations.Migration):

    dependencies = [
        ('mocks', '0001_create_schema'),
    ]

    operations = [
        migrations.RunSQL(
            sql="""
BEGIN;

  create or replace function mocks.now()
  returns timestamptz as
  $function$
    declare
      mockedValue text;
      returnValue timestamptz;
    begin
      -- look at the database options if there is a value set
      -- if it's not set the current_setting method returns nil and we return now()
      mockedValue := current_setting('mocks.mocked_timestamp', true);

      if mockedValue is null then
        returnValue := pg_catalog.now()::timestamptz;
      else
        returnValue := to_timestamp(mockedValue::decimal)::timestamptz;
      end if;

      return returnValue;

    exception
      -- In case of a parsing error or anything else, we return the regular now() behaviour
      when others then
        raise notice 'mocks.now() encountered an error and defaulted back to the regular behaviour';
        return pg_catalog.now();
    end;
  $function$ language plpgsql volatile;

  grant execute on function mocks.now to industry_user, cas_director, cas_admin, cas_analyst, cas_pending, cas_view_only;

COMMIT;
""",
            reverse_sql="drop function mocks.now();",
        ),
    ]
