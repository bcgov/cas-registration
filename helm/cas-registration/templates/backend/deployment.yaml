apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "cas-registration.fullname" . }}-backend
  labels:
    component: backend
{{- include "cas-registration.labels" . | nindent 4 }}
spec:
{{- if not .Values.backend.autoscaling.enabled }}
  replicas: {{ .Values.backend.replicaCount }}
{{- end }}
  selector:
    matchLabels:
{{- include "cas-registration.selectorLabels" . | nindent 6 }}
      component: backend
  strategy:
    type: RollingUpdate
  template:
    metadata:
      labels:
{{- include "cas-registration.selectorLabels" . | nindent 8 }}
        component: backend
    spec:
{{- if not (hasSuffix "-prod" .Release.Namespace)}}
      initContainers:
      - env:
          - name: PGUSER
            valueFrom:
              secretKeyRef:
                key: user
                name: cas-obps-postgres-pguser-postgres
          - name: APP_USER
            valueFrom:
              secretKeyRef:
                key: user
                name: cas-obps-postgres-pguser-registration
          - name: PGPASSWORD
            valueFrom:
              secretKeyRef:
                key: password
                name: cas-obps-postgres-pguser-postgres
          - name: PGDATABASE
            valueFrom:
              secretKeyRef:
                key: dbname
                name: cas-obps-postgres-pguser-postgres
          - name: PGPORT
            valueFrom:
              secretKeyRef:
                key: port
                name: cas-obps-postgres-pguser-postgres
          - name: PGHOST
            valueFrom:
              secretKeyRef:
                key: host
                name: cas-obps-postgres-pguser-postgres
          - name: ALLOWED_HOSTS
            value: '*'
        imagePullPolicy: {{ .Values.backend.image.pullPolicy }}
        resources: {{ toYaml .Values.backend.resources | nindent 12 }}
{{- if (hasSuffix "-test" .Release.Namespace)}}
        command:
          - /usr/bin/env
          - bash
          - -c
          - |
            psql -c "create schema if not exists preserve;";
            psql -c "create table preserve.user (first_name text, last_name text, position_title text, email text, phone_number text, user_guid uuid, business_guid uuid, app_role_id text);";
            psql -c "insert into preserve.user (select * from erc.user);";
            psql -c "drop schema public cascade;";
            psql -c "create schema public;";
            psql -c "grant all on schema public to $(APP_USER);";
            psql -c "drop schema erc cascade;";
            psql -c "drop schema erc_history cascade;";
{{ end }}
{{- if (hasSuffix "-dev" .Release.Namespace)}}
        command:
          - /usr/bin/env
          - bash
          - -c
          - |
            psql -c "drop schema public cascade;";
            psql -c "create schema public;";
            psql -c "grant all on schema public to $(APP_USER);";
            psql -c "drop schema erc cascade;";
            psql -c "drop schema erc_history cascade;";
{{ end }}
{{ end }}
      containers:
        - name: {{ .Release.Name }}-backend
          image: "{{ .Values.backend.image.repository }}:{{ .Values.defaultImageTag | default .Values.backend.image.tag }}"
          imagePullPolicy: {{ .Values.backend.image.pullPolicy }}
          env:
            - name: DJANGO_SECRET_KEY
              valueFrom:
                secretKeyRef:
                  key: django-secret-key
                  name: {{ .Release.Name }}-backend
            - name: DB_USER
              valueFrom:
                secretKeyRef:
                  key: user
                  name: cas-obps-postgres-pguser-registration
            - name: DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  key: password
                  name: cas-obps-postgres-pguser-registration
            - name: DB_NAME
              valueFrom:
                secretKeyRef:
                  key: dbname
                  name: cas-obps-postgres-pguser-registration
            - name: DB_PORT
              valueFrom:
                secretKeyRef:
                  key: port
                  name: cas-obps-postgres-pguser-registration
            - name: DB_HOST
              valueFrom:
                secretKeyRef:
                  key: host
                  name: cas-obps-postgres-pguser-registration
            - name: ALLOWED_HOSTS
              value: '*'
            - name: GS_BUCKET_NAME
              valueFrom:
                secretKeyRef:
                  key: bucket_name
                  name: gcp-{{ .Release.Namespace }}-reg-attachments-service-account-key
            - name: GOOGLE_APPLICATION_CREDENTIALS
              value: "/attachment-credentials/attachment-credentials.json"
            - name: ENVIRONMENT
              value: {{ .Values.backend.environment }}
          ports:
            - containerPort: {{ .Values.backend.service.port }}
              protocol: TCP
          readinessProbe:
            httpGet:
              path: /readiness
              port: 8000
            # we want the readiness threshold to fail fast,
            # to prevent any request from going to a pod that is not ready
            failureThreshold: 1
            successThreshold: 1
            periodSeconds: 30
            timeoutSeconds: 5
            initialDelaySeconds: 120
          livenessProbe:
            # the liveness probe is here to ensure that a pod does not get
            # stuck in a shutdown state. It needs to allow enough time for
            # the registered shutdown handler to run to completion.
            httpGet:
              path: /liveness
              port: 8000
            initialDelaySeconds: 150
            periodSeconds: 30
            failureThreshold: 3
            successThreshold: 1
            timeoutSeconds: 5
          resources: {{ toYaml .Values.backend.resources | nindent 12 }}
          volumeMounts:
            - mountPath: "/attachment-credentials"
              name: gcs-attachment-credentials
              readOnly: true
      volumes:
        - name: gcs-attachment-credentials
          secret:
            secretName: gcp-{{ .Release.Namespace }}-reg-attachments-service-account-key
            items:
            - key: credentials.json
              path: attachment-credentials.json
      restartPolicy: Always
